"use strict";(self.webpackChunkvendure_admin_ui=self.webpackChunkvendure_admin_ui||[]).push([[142],{81142:function(e,t,i){i.r(t),i.d(t,{InvoicesModule:function(){return Z}});var n=i(41460),o=i(49962),r=i(3189),s=i(83974);const c=s.ZP`
  mutation upsertInvoiceConfig($input: InvoiceConfigInput!) {
    upsertInvoiceConfig(input: $input) {
      id
      enabled
      templateString
    }
  }
`,l=s.ZP`
  query invoiceConfig {
    invoiceConfig {
      id
      enabled
      templateString
    }
  }
`,a=s.ZP`
  query invoices($input: InvoicesListInput) {
    invoices(input: $input) {
      items {
        id
        createdAt
        orderCode
        orderId
        customerEmail
        invoiceNumber
        downloadUrl
      }
      totalItems
    }
  }
`;var d=i(51694),u=i(21067),m=i(56258),g=i(70942);function h(e,t){if(1&e){const e=d.EpF();d.TgZ(0,"clr-accordion-content"),d.TgZ(1,"section",3),d.TgZ(2,"form",4),d.TgZ(3,"vdr-form-field",5),d.TgZ(4,"clr-checkbox-wrapper"),d._UZ(5,"input",6),d.qZA(),d.qZA(),d.TgZ(6,"vdr-form-field",7),d._UZ(7,"textarea",8),d.qZA(),d.TgZ(8,"button",1),d.NdJ("click",function(){return d.CHM(e),d.oxw().save()}),d._uU(9," Save "),d.qZA(),d.TgZ(10,"button",9),d.NdJ("click",function(){return d.CHM(e),d.oxw().testDownload()}),d._uU(11," Preview "),d.qZA(),d._UZ(12,"vdr-help-tooltip",10),d.qZA(),d.qZA(),d.qZA()}if(2&e){const e=d.oxw();d.xp6(2),d.Q6J("formGroup",e.form),d.xp6(6),d.Q6J("disabled",e.form.invalid||e.form.pristine)}}const v=function(e){return["/orders",e]};function p(e,t){if(1&e&&(d.TgZ(0,"td",11),d._uU(1),d.qZA(),d.TgZ(2,"td",11),d._uU(3),d.ALo(4,"date"),d.qZA(),d.TgZ(5,"td",11),d._uU(6),d.qZA(),d.TgZ(7,"td",11),d.TgZ(8,"a",12),d._uU(9),d.qZA(),d.qZA(),d.TgZ(10,"td",11),d.TgZ(11,"a",13),d._UZ(12,"clr-icon",14),d.qZA(),d.qZA()),2&e){const e=t.item;d.xp6(1),d.Oqu(e.invoiceNumber),d.xp6(2),d.hij(" ",d.lcZ(4,6,e.createdAt)," "),d.xp6(3),d.Oqu(e.customerEmail),d.xp6(2),d.Q6J("routerLink",d.VKq(8,v,e.orderId)),d.xp6(1),d.hij(" ",e.orderCode," "),d.xp6(2),d.Q6J("href",e.downloadUrl,d.LSH)}}class f{constructor(e,t,i,n,r){this.formBuilder=e,this.dataService=t,this.changeDetector=i,this.notificationService=n,this.localStorageService=r,this.itemsPerPage=10,this.page=1,this.selectedInvoices=[],this.isSelected=e=>{var t;return!!(null===(t=this.selectedInvoices)||void 0===t?void 0:t.find(t=>t.id===e.id))},this.form=this.formBuilder.group({enabled:["enabled"],templateString:["templateString"]}),this.serverPath=(0,o.VC)()}ngOnInit(){return(0,r.mG)(this,void 0,void 0,function*(){yield this.dataService.query(l).mapStream(e=>e.invoiceConfig).subscribe(e=>{this.form.controls.enabled.setValue(null==e?void 0:e.enabled),this.form.controls.templateString.setValue(null==e?void 0:e.templateString)}),yield this.getAllInvoices()})}getAllInvoices(){return(0,r.mG)(this,void 0,void 0,function*(){yield this.dataService.query(a,{input:{page:this.page,itemsPerPage:this.itemsPerPage}}).mapStream(e=>e.invoices).subscribe(e=>{this.invoicesList=e})})}save(){return(0,r.mG)(this,void 0,void 0,function*(){try{if(this.form.dirty){const e=this.form.value,{upsertInvoiceConfig:t}=yield this.dataService.mutate(c,{input:{enabled:e.enabled,templateString:e.templateString}}).toPromise();this.form.controls.enabled.setValue(t.enabled),this.form.controls.templateString.setValue(t.templateString)}this.form.markAsPristine(),this.changeDetector.markForCheck(),this.notificationService.success("common.notify-update-success",{entity:"InvoiceConfig"})}catch(e){this.notificationService.error("common.notify-update-error",{entity:"InvoiceConfig"})}})}downloadSelected(){return(0,r.mG)(this,void 0,void 0,function*(){try{const e=this.selectedInvoices.map(e=>e.invoiceNumber).join(","),t=yield fetch(`${this.serverPath}/invoices/download?nrs=${e}`,{headers:this.getHeaders()});if(!t.ok){const e=yield t.json();throw Error(null==e?void 0:e.message)}const i=yield t.blob();yield this.downloadBlob(i,"invoices.zip")}catch(e){console.error(e),this.notificationService.error(e.message)}})}setPageNumber(e){return(0,r.mG)(this,void 0,void 0,function*(){this.page=e,yield this.getAllInvoices()})}setItemsPerPage(e){return(0,r.mG)(this,void 0,void 0,function*(){this.page=1,this.itemsPerPage=Number(e),yield this.getAllInvoices()})}toggleSelect(e){this.isSelected(e)?this.selectedInvoices=this.selectedInvoices.filter(t=>t.id!==e.id):this.selectedInvoices.push(e)}toggleSelectAll(){var e;this.areAllSelected()?this.selectedInvoices=[]:this.selectedInvoices=(null===(e=this.invoicesList)||void 0===e?void 0:e.items)||[]}areAllSelected(){var e;return this.selectedInvoices.length===(null===(e=this.invoicesList)||void 0===e?void 0:e.items.length)}testDownload(){return(0,r.mG)(this,void 0,void 0,function*(){try{const e=this.form.value.templateString,t=yield fetch(`${this.serverPath}/invoices/preview`,{headers:Object.assign(Object.assign({},this.getHeaders()),{"Content-Type":"application/json"}),method:"POST",body:JSON.stringify({template:e})});if(!t.ok){const e=yield t.json();throw Error(null==e?void 0:e.message)}const i=yield t.blob();yield this.downloadBlob(i,"test-invoice.pdf",!0)}catch(e){console.error(e),this.notificationService.error(e.message)}})}getHeaders(){const e={},t=this.localStorageService.get("activeChannelToken");t&&(e["vendure-token"]=t);const i=this.localStorageService.get("authToken");return i&&(e.authorization=`Bearer ${i}`),e}downloadBlob(e,t,i=!1){return(0,r.mG)(this,void 0,void 0,function*(){const n=window.URL.createObjectURL(e),o=document.createElement("a");document.body.appendChild(o),o.setAttribute("hidden","true"),o.href=n,i||(o.download=t),o.setAttribute("target","_blank"),o.click()})}}f.\u0275fac=function(e){return new(e||f)(d.Y36(u.qu),d.Y36(o.DoR),d.Y36(d.sBO),d.Y36(o.gqp),d.Y36(o.n2A))},f.\u0275cmp=d.Xpm({type:f,selectors:[["invoices-component"]],decls:23,vars:7,consts:[[4,"clrIfExpanded"],[1,"btn","btn-primary",3,"disabled","click"],[3,"items","itemsPerPage","totalItems","currentPage","allSelected","isRowSelectedFn","pageChange","itemsPerPageChange","rowSelectChange","allSelectChange"],[1,"form-block"],[1,"form",3,"formGroup"],["label","Generate invoices on","for","enabled"],["type","checkbox","clrCheckbox","","formControlName","enabled"],["label","HTML template","for","templateString"],["id","templateString","type","text","formControlName","templateString",2,"height","300px","width","100%"],[1,"btn","btn-secondary",3,"click"],["content","Preview the HTML template. Uses the most recent placed order. Just a preview, it doesn't save any invoices!"],[1,"left","align-middle"],[3,"routerLink"],["target","_blank",3,"href"],["shape","download"]],template:function(e,t){1&e&&(d.TgZ(0,"clr-accordion"),d.TgZ(1,"clr-accordion-panel"),d.TgZ(2,"clr-accordion-title"),d._uU(3,"Settings"),d.qZA(),d.YNc(4,h,13,2,"clr-accordion-content",0),d.qZA(),d.qZA(),d._UZ(5,"hr"),d.TgZ(6,"section"),d.TgZ(7,"h2"),d._uU(8,"Created invoices"),d.qZA(),d.TgZ(9,"button",1),d.NdJ("click",function(){return t.downloadSelected()}),d._uU(10," Download "),d.qZA(),d.TgZ(11,"vdr-data-table",2),d.NdJ("pageChange",function(e){return t.setPageNumber(e)})("itemsPerPageChange",function(e){return t.setItemsPerPage(e)})("rowSelectChange",function(e){return t.toggleSelect(e)})("allSelectChange",function(){return t.toggleSelectAll()}),d.TgZ(12,"vdr-dt-column"),d._uU(13,"Invoice nr."),d.qZA(),d.TgZ(14,"vdr-dt-column"),d._uU(15,"Created"),d.qZA(),d.TgZ(16,"vdr-dt-column"),d._uU(17,"Customer"),d.qZA(),d.TgZ(18,"vdr-dt-column"),d._uU(19,"Order"),d.qZA(),d.TgZ(20,"vdr-dt-column"),d._uU(21,"Download"),d.qZA(),d.YNc(22,p,13,10,"ng-template"),d.qZA(),d.qZA()),2&e&&(d.xp6(9),d.Q6J("disabled",0==(null==t.selectedInvoices?null:t.selectedInvoices.length)),d.xp6(2),d.Q6J("items",null==t.invoicesList?null:t.invoicesList.items)("itemsPerPage",t.itemsPerPage)("totalItems",null==t.invoicesList?null:t.invoicesList.totalItems)("currentPage",t.page)("allSelected",t.areAllSelected())("isRowSelectedFn",t.isSelected))},directives:[m.bZL,m.twP,m.GmI,m.dxz,m.UJ5,m.Nz$,m.DbV,o.Qj_,o.Egy,m.r6y,u._Y,u.JL,u.sg,o.hgI,m.PEh,o.y_K,u.Wl,m.KKC,u.JJ,u.u,u.Fj,o.opf,n.yS,m.qvL],pipes:[g.uU],encapsulation:2});class Z{}Z.\u0275fac=function(e){return new(e||Z)},Z.\u0275mod=d.oAB({type:Z}),Z.\u0275inj=d.cJS({providers:[],imports:[[o.m81,n.Bz.forChild([{path:"",pathMatch:"full",component:f,data:{breadcrumb:"Invoices"}}])]]})}}]);
//# sourceMappingURL=142-es2015.c36a4566bfb99a5a4153.js.map