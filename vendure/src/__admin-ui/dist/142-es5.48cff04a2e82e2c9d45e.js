!function(){"use strict";var e,t,n;function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function o(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function a(e,t){return t||(t=e.slice(0)),Object.freeze(Object.defineProperties(e,{raw:{value:Object.freeze(t)}}))}(self.webpackChunkvendure_admin_ui=self.webpackChunkvendure_admin_ui||[]).push([[142],{81142:function(i,c,s){s.r(c),s.d(c,{InvoicesModule:function(){return A}});var u=s(41460),l=s(39155),d=s(3189),v=s(83974),m=v.ZP(e||(e=a(["\n  mutation upsertInvoiceConfig($input: InvoiceConfigInput!) {\n    upsertInvoiceConfig(input: $input) {\n      id\n      enabled\n      templateString\n    }\n  }\n"]))),f=v.ZP(t||(t=a(["\n  query invoiceConfig {\n    invoiceConfig {\n      id\n      enabled\n      templateString\n    }\n  }\n"]))),g=v.ZP(n||(n=a(["\n  query invoices($input: InvoicesListInput) {\n    invoices(input: $input) {\n      items {\n        id\n        createdAt\n        orderCode\n        orderId\n        customerEmail\n        invoiceNumber\n        downloadUrl\n      }\n      totalItems\n    }\n  }\n"]))),h=s(51694),p=s(21067),b=s(96789),Z=s(70942);function S(e,t){if(1&e){var n=h.EpF();h.TgZ(0,"clr-accordion-content"),h.TgZ(1,"section",3),h.TgZ(2,"form",4),h.TgZ(3,"vdr-form-field",5),h.TgZ(4,"clr-checkbox-wrapper"),h._UZ(5,"input",6),h.qZA(),h.qZA(),h.TgZ(6,"vdr-form-field",7),h._UZ(7,"textarea",8),h.qZA(),h.TgZ(8,"button",1),h.NdJ("click",function(){return h.CHM(n),h.oxw().save()}),h._uU(9," Save "),h.qZA(),h.TgZ(10,"button",9),h.NdJ("click",function(){return h.CHM(n),h.oxw().testDownload()}),h._uU(11," Preview "),h.qZA(),h._UZ(12,"vdr-help-tooltip",10),h.qZA(),h.qZA(),h.qZA()}if(2&e){var r=h.oxw();h.xp6(2),h.Q6J("formGroup",r.form),h.xp6(6),h.Q6J("disabled",r.form.invalid||r.form.pristine)}}var w=function(e){return["/orders",e]};function k(e,t){if(1&e&&(h.TgZ(0,"td",11),h._uU(1),h.qZA(),h.TgZ(2,"td",11),h._uU(3),h.ALo(4,"date"),h.qZA(),h.TgZ(5,"td",11),h._uU(6),h.qZA(),h.TgZ(7,"td",11),h.TgZ(8,"a",12),h._uU(9),h.qZA(),h.qZA(),h.TgZ(10,"td",11),h.TgZ(11,"a",13),h._UZ(12,"clr-icon",14),h.qZA(),h.qZA()),2&e){var n=t.item;h.xp6(1),h.Oqu(n.invoiceNumber),h.xp6(2),h.hij(" ",h.lcZ(4,6,n.createdAt)," "),h.xp6(3),h.Oqu(n.customerEmail),h.xp6(2),h.Q6J("routerLink",h.VKq(8,w,n.orderId)),h.xp6(1),h.hij(" ",n.orderCode," "),h.xp6(2),h.Q6J("href",n.downloadUrl,h.LSH)}}var x=function(){function e(t,n,i,o,a){var c=this;r(this,e),this.formBuilder=t,this.dataService=n,this.changeDetector=i,this.notificationService=o,this.localStorageService=a,this.itemsPerPage=10,this.page=1,this.selectedInvoices=[],this.isSelected=function(e){var t;return!!(null===(t=c.selectedInvoices)||void 0===t?void 0:t.find(function(t){return t.id===e.id}))},this.form=this.formBuilder.group({enabled:["enabled"],templateString:["templateString"]}),this.serverPath=(0,l.VC)()}return o(e,[{key:"ngOnInit",value:function(){return(0,d.mG)(this,void 0,void 0,regeneratorRuntime.mark(function e(){var t=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.dataService.query(f).mapStream(function(e){return e.invoiceConfig}).subscribe(function(e){t.form.controls.enabled.setValue(null==e?void 0:e.enabled),t.form.controls.templateString.setValue(null==e?void 0:e.templateString)});case 2:return e.next=4,this.getAllInvoices();case 4:case"end":return e.stop()}},e,this)}))}},{key:"getAllInvoices",value:function(){return(0,d.mG)(this,void 0,void 0,regeneratorRuntime.mark(function e(){var t=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.dataService.query(g,{input:{page:this.page,itemsPerPage:this.itemsPerPage}}).mapStream(function(e){return e.invoices}).subscribe(function(e){t.invoicesList=e});case 2:case"end":return e.stop()}},e,this)}))}},{key:"save",value:function(){return(0,d.mG)(this,void 0,void 0,regeneratorRuntime.mark(function e(){var t,n,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,!this.form.dirty){e.next=8;break}return t=this.form.value,e.next=5,this.dataService.mutate(m,{input:{enabled:t.enabled,templateString:t.templateString}}).toPromise();case 5:n=e.sent,r=n.upsertInvoiceConfig,this.form.controls.enabled.setValue(r.enabled),this.form.controls.templateString.setValue(r.templateString);case 8:this.form.markAsPristine(),this.changeDetector.markForCheck(),this.notificationService.success("common.notify-update-success",{entity:"InvoiceConfig"}),e.next=14;break;case 11:e.prev=11,e.t0=e.catch(0),this.notificationService.error("common.notify-update-error",{entity:"InvoiceConfig"});case 14:case"end":return e.stop()}},e,this,[[0,11]])}))}},{key:"downloadSelected",value:function(){return(0,d.mG)(this,void 0,void 0,regeneratorRuntime.mark(function e(){var t,n,r,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=this.selectedInvoices.map(function(e){return e.invoiceNumber}).join(","),e.next=4,fetch("".concat(this.serverPath,"/invoices/download?nrs=").concat(t),{headers:this.getHeaders()});case 4:if((n=e.sent).ok){e.next=10;break}return e.next=8,n.json();case 8:throw r=e.sent,Error(null==r?void 0:r.message);case 10:return e.next=12,n.blob();case 12:return i=e.sent,e.next=15,this.downloadBlob(i,"invoices.zip");case 15:e.next=20;break;case 17:e.prev=17,e.t0=e.catch(0),console.error(e.t0),this.notificationService.error(e.t0.message);case 20:case"end":return e.stop()}},e,this,[[0,17]])}))}},{key:"setPageNumber",value:function(e){return(0,d.mG)(this,void 0,void 0,regeneratorRuntime.mark(function t(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return this.page=e,t.next=3,this.getAllInvoices();case 3:case"end":return t.stop()}},t,this)}))}},{key:"setItemsPerPage",value:function(e){return(0,d.mG)(this,void 0,void 0,regeneratorRuntime.mark(function t(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return this.page=1,this.itemsPerPage=Number(e),t.next=4,this.getAllInvoices();case 4:case"end":return t.stop()}},t,this)}))}},{key:"toggleSelect",value:function(e){this.isSelected(e)?this.selectedInvoices=this.selectedInvoices.filter(function(t){return t.id!==e.id}):this.selectedInvoices.push(e)}},{key:"toggleSelectAll",value:function(){var e;this.areAllSelected()?this.selectedInvoices=[]:this.selectedInvoices=(null===(e=this.invoicesList)||void 0===e?void 0:e.items)||[]}},{key:"areAllSelected",value:function(){var e;return this.selectedInvoices.length===(null===(e=this.invoicesList)||void 0===e?void 0:e.items.length)}},{key:"testDownload",value:function(){return(0,d.mG)(this,void 0,void 0,regeneratorRuntime.mark(function e(){var t,n,r,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=this.form.value.templateString,e.next=4,fetch("".concat(this.serverPath,"/invoices/preview"),{headers:Object.assign(Object.assign({},this.getHeaders()),{"Content-Type":"application/json"}),method:"POST",body:JSON.stringify({template:t})});case 4:if((n=e.sent).ok){e.next=10;break}return e.next=8,n.json();case 8:throw r=e.sent,Error(null==r?void 0:r.message);case 10:return e.next=12,n.blob();case 12:return i=e.sent,e.next=15,this.downloadBlob(i,"test-invoice.pdf",!0);case 15:e.next=20;break;case 17:e.prev=17,e.t0=e.catch(0),console.error(e.t0),this.notificationService.error(e.t0.message);case 20:case"end":return e.stop()}},e,this,[[0,17]])}))}},{key:"getHeaders",value:function(){var e={},t=this.localStorageService.get("activeChannelToken");t&&(e["vendure-token"]=t);var n=this.localStorageService.get("authToken");return n&&(e.authorization="Bearer ".concat(n)),e}},{key:"downloadBlob",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return(0,d.mG)(this,void 0,void 0,regeneratorRuntime.mark(function r(){var i,o;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:i=window.URL.createObjectURL(e),o=document.createElement("a"),document.body.appendChild(o),o.setAttribute("hidden","true"),o.href=i,n||(o.download=t),o.setAttribute("target","_blank"),o.click();case 2:case"end":return r.stop()}},r)}))}}]),e}();x.\u0275fac=function(e){return new(e||x)(h.Y36(p.qu),h.Y36(l.DoR),h.Y36(h.sBO),h.Y36(l.gqp),h.Y36(l.n2A))},x.\u0275cmp=h.Xpm({type:x,selectors:[["invoices-component"]],decls:23,vars:7,consts:[[4,"clrIfExpanded"],[1,"btn","btn-primary",3,"disabled","click"],[3,"items","itemsPerPage","totalItems","currentPage","allSelected","isRowSelectedFn","pageChange","itemsPerPageChange","rowSelectChange","allSelectChange"],[1,"form-block"],[1,"form",3,"formGroup"],["label","Generate invoices on","for","enabled"],["type","checkbox","clrCheckbox","","formControlName","enabled"],["label","HTML template","for","templateString"],["id","templateString","type","text","formControlName","templateString",2,"height","300px","width","100%"],[1,"btn","btn-secondary",3,"click"],["content","Preview the HTML template. Uses the most recent placed order. Just a preview, it doesn't save any invoices!"],[1,"left","align-middle"],[3,"routerLink"],["target","_blank",3,"href"],["shape","download"]],template:function(e,t){1&e&&(h.TgZ(0,"clr-accordion"),h.TgZ(1,"clr-accordion-panel"),h.TgZ(2,"clr-accordion-title"),h._uU(3,"Settings"),h.qZA(),h.YNc(4,S,13,2,"clr-accordion-content",0),h.qZA(),h.qZA(),h._UZ(5,"hr"),h.TgZ(6,"section"),h.TgZ(7,"h2"),h._uU(8,"Created invoices"),h.qZA(),h.TgZ(9,"button",1),h.NdJ("click",function(){return t.downloadSelected()}),h._uU(10," Download "),h.qZA(),h.TgZ(11,"vdr-data-table",2),h.NdJ("pageChange",function(e){return t.setPageNumber(e)})("itemsPerPageChange",function(e){return t.setItemsPerPage(e)})("rowSelectChange",function(e){return t.toggleSelect(e)})("allSelectChange",function(){return t.toggleSelectAll()}),h.TgZ(12,"vdr-dt-column"),h._uU(13,"Invoice nr."),h.qZA(),h.TgZ(14,"vdr-dt-column"),h._uU(15,"Created"),h.qZA(),h.TgZ(16,"vdr-dt-column"),h._uU(17,"Customer"),h.qZA(),h.TgZ(18,"vdr-dt-column"),h._uU(19,"Order"),h.qZA(),h.TgZ(20,"vdr-dt-column"),h._uU(21,"Download"),h.qZA(),h.YNc(22,k,13,10,"ng-template"),h.qZA(),h.qZA()),2&e&&(h.xp6(9),h.Q6J("disabled",0==(null==t.selectedInvoices?null:t.selectedInvoices.length)),h.xp6(2),h.Q6J("items",null==t.invoicesList?null:t.invoicesList.items)("itemsPerPage",t.itemsPerPage)("totalItems",null==t.invoicesList?null:t.invoicesList.totalItems)("currentPage",t.page)("allSelected",t.areAllSelected())("isRowSelectedFn",t.isSelected))},directives:[b.bZL,b.twP,b.GmI,b.dxz,b.UJ5,b.Nz$,b.DbV,l.Qj_,l.Egy,b.r6y,p._Y,p.JL,p.sg,l.hgI,b.PEh,l.y_K,p.Wl,b.KKC,p.JJ,p.u,p.Fj,l.opf,u.yS,b.qvL],pipes:[Z.uU],encapsulation:2});var A=o(function e(){r(this,e)});A.\u0275fac=function(e){return new(e||A)},A.\u0275mod=h.oAB({type:A}),A.\u0275inj=h.cJS({providers:[],imports:[[l.m81,u.Bz.forChild([{path:"",pathMatch:"full",component:x,data:{breadcrumb:"Invoices"}}])]]})}}])}();
//# sourceMappingURL=142-es5.48cff04a2e82e2c9d45e.js.map