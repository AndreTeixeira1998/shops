"use strict";(self.webpackChunkvendure_admin=self.webpackChunkvendure_admin||[]).push([[208],{6208:(w,v,i)=>{i.r(v),i.d(v,{InvoicesModule:()=>f});var g=i(4285),l=i(1767),s=i(6642),h=i(5653),b=i(3223),y=i(7126);var e=i(6108),c=i(5086),d=i(2977),S=i(8046),k=i(1317);function T(u,t){if(1&u&&e._UZ(0,"vdr-dynamic-form-input",10),2&u){const o=e.oxw();e.Q6J("readonly",!1)("def",o.htmlFormInputConfigArgsDef)("control",o.form.get("templateString"))}}class m{constructor(t,o,n,r,a){this.formBuilder=t,this.dataService=o,this.changeDetector=n,this.notificationService=r,this.localStorageService=a,this.invoicePreviewLoading=!1,this.renderNow=!1,this.htmlFormInputConfigArgsDef={name:"templateString",type:"text",list:!1,required:!1,ui:{component:"html-editor-form-input"}},this.form=this.formBuilder.group({enabled:["enabled"],templateString:["templateString"],orderCode:[""]}),this.serverPath=(0,l.VC)()}ngOnInit(){var t=this;return(0,s.Z)(function*(){t.dataService.query(h.kR).mapStream(o=>o.invoiceConfig).subscribe(o=>{t.form.controls.enabled.setValue(o?.enabled),t.renderNow=!0,t.form.controls.templateString.setValue(o?.templateString)})})()}save(){var t=this;return(0,s.Z)(function*(){try{if(t.form.dirty){const o=t.form.value,n=yield t.dataService.mutate(h.Dr,{input:{enabled:o.enabled,templateString:o.templateString}}),{upsertInvoiceConfig:r}=yield function C(u,t){const o="object"==typeof t;return new Promise((n,r)=>{const a=new y.Hp({next:p=>{n(p),a.unsubscribe()},error:r,complete:()=>{o?n(t.defaultValue):r(new b.K)}});u.subscribe(a)})}(n);t.form.controls.enabled.setValue(r.enabled),t.form.controls.templateString.setValue(r.templateString)}t.form.markAsPristine(),t.changeDetector.markForCheck(),t.notificationService.success("common.notify-update-success",{entity:"InvoiceConfig"})}catch{t.notificationService.error("common.notify-update-error",{entity:"InvoiceConfig"})}})()}testDownload(){var t=this;return(0,s.Z)(function*(){try{const o=t.form.value.templateString,n=t.form.value.orderCode;t.invoicePreviewLoading=!0,t.changeDetector.markForCheck();const r=yield fetch(`${t.serverPath}/invoices/preview/${n}`,{headers:{...t.getHeaders(),"Content-Type":"application/json"},method:"POST",body:JSON.stringify({template:o})});if(!r.ok){const p=yield r.json();throw Error(p?.message)}const a=yield r.blob();yield t.downloadBlob(a,"test-invoice.pdf",!0)}catch(o){console.error(o),t.notificationService.error(o?.message)}t.invoicePreviewLoading=!1,t.changeDetector.markForCheck()})()}getHeaders(){const t={},o=this.localStorageService.get("activeChannelToken");o&&(t["vendure-token"]=o);const n=this.localStorageService.get("authToken");return n&&(t.authorization=`Bearer ${n}`),t}downloadBlob(t,o,n=!1){return(0,s.Z)(function*(){const r=window.URL.createObjectURL(t),a=document.createElement("a");document.body.appendChild(a),a.setAttribute("hidden","true"),a.href=r,n||(a.download=o),a.setAttribute("target","_blank"),a.click()})()}static#e=this.\u0275fac=function(o){return new(o||m)(e.Y36(c.qu),e.Y36(l.DoR),e.Y36(e.sBO),e.Y36(l.gqp),e.Y36(l.n2A))};static#t=this.\u0275cmp=e.Xpm({type:m,selectors:[["invoices-component"]],decls:20,vars:7,consts:[[1,"page-block"],[1,"btn","btn-primary",3,"disabled","click"],[1,"form",3,"formGroup"],["label","Generate invoices on","for","enabled"],["type","checkbox","clrCheckbox","","formControlName","enabled"],["label","HTML template","for","templateString"],["formControlName","templateString","style","max-width: 100%;",3,"readonly","def","control",4,"ngIf"],["label","Order Code","for","enabled"],["type","text","clrInput","","formControlName","orderCode"],[1,"btn","btn-primary","preview-button",3,"disabled","click"],["formControlName","templateString",2,"max-width","100%",3,"readonly","def","control"]],template:function(o,n){if(1&o&&(e.TgZ(0,"div",0)(1,"vdr-page-block")(2,"vdr-action-bar")(3,"vdr-ab-right")(4,"button",1),e.NdJ("click",function(){return n.save()}),e._uU(5),e.ALo(6,"translate"),e.qZA()()()(),e.TgZ(7,"vdr-page-block")(8,"vdr-card")(9,"form",2)(10,"vdr-form-field",3)(11,"clr-checkbox-wrapper"),e._UZ(12,"input",4),e.qZA()(),e.TgZ(13,"vdr-form-field",5),e.YNc(14,T,1,3,"vdr-dynamic-form-input",6),e.qZA(),e.TgZ(15,"vdr-form-field",7)(16,"clr-input-container"),e._UZ(17,"input",8),e.qZA()(),e.TgZ(18,"button",9),e.NdJ("click",function(){return n.testDownload()}),e._uU(19," Preview Template "),e.qZA()()()()()),2&o){let r;e.xp6(4),e.Q6J("disabled",n.form.invalid||(null==(r=n.form.get("templateString"))?null:r.pristine)),e.xp6(1),e.hij(" ",e.lcZ(6,5,"common.update")," "),e.xp6(4),e.Q6J("formGroup",n.form),e.xp6(5),e.Q6J("ngIf",n.renderNow),e.xp6(4),e.Q6J("disabled",n.invoicePreviewLoading)}},dependencies:[d.KKC,d.PEh,d.xRP,d.G55,S.O5,c._Y,c.Fj,c.Wl,c.JJ,c.JL,c.sg,c.u,l.KkL,l.mz,l.hgI,l.y_K,l.zJY,l.AkF,l.TVJ,k.X$],styles:["button.preview-button[_ngcontent-%COMP%]{margin-top:1em!important}"]})}class f{static#e=this.\u0275fac=function(o){return new(o||f)};static#t=this.\u0275mod=e.oAB({type:f});static#o=this.\u0275inj=e.cJS({imports:[l.m81,g.Bz.forChild([{path:"",pathMatch:"full",component:m,data:{breadcrumb:"Invoices"}}])]})}}}]);
//# sourceMappingURL=208.69ae993ae893b3d8.js.map